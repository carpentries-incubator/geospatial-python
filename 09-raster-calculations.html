<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Introduction to Geospatial Raster and Vector Data with Python: Raster Calculations in Python</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><span class="badge text-bg-info">
          <abbr title="This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#polishing-beta-stage" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-circle" style="border-radius: 5px"></i>
              Beta
            </a>
            <span class="visually-hidden">This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/09-raster-calculations.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Introduction to Geospatial Raster and Vector Data with Python
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Introduction to Geospatial Raster and Vector Data with Python
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to Geospatial Raster and Vector Data with Python
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 64%" class="percentage">
    64%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 64%" aria-valuenow="64" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/09-raster-calculations.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-intro-raster-data.html">1. Introduction to Raster Data</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-intro-vector-data.html">2. Introduction to Vector Data</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-crs.html">3. Coordinate Reference Systems</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-geo-landscape.html">4. The Geospatial Landscape</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-access-data.html">5. Access satellite imagery using Python</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-raster-intro.html">6. Read and visualize raster data</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-vector-data-in-python.html">7. Vector data in Python</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-crop-raster-data.html">8. Crop raster data with rioxarray and geopandas</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        9. Raster Calculations in Python
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#introduction">Introduction</a></li>
<li><a href="#raster-math">Raster Math</a></li>
<li><a href="#classifying-continuous-rasters-in-python">Classifying Continuous Rasters in Python</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="10-zonal-statistics.html">10. Calculating Zonal Statistics on Rasters</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="11-parallel-raster-computations.html">11. Parallel raster computations using Dask</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>

                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="08-crop-raster-data.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="10-zonal-statistics.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="08-crop-raster-data.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Crop raster data
        </a>
        <a class="chapter-link float-end" href="10-zonal-statistics.html" rel="next">
          Next: Calculating Zonal...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Raster Calculations in Python</h1>
        <p>Last updated on 2023-08-14 |

        <a href="https://github.com/carpentries-incubator/geospatial-python/edit/main/episodes/09-raster-calculations.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How do I perform calculations on rasters and extract pixel values
for defined locations?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Carry out operations with two rasters using Python’s built-in math
operators.</li>
<li>Reclassify a continuous raster to a categorical raster.</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
<a class="anchor" aria-label="anchor" href="#introduction"></a></h2>
<hr class="half-width"><p>We often want to combine values of and perform calculations on
rasters to create a new output raster. This episode covers how to
perform basic math operations using raster datasets. It also illustrates
how to match rasters with different resolutions so that they can be used
in the same calculation. As an example, we will calculate a vegetation
index over one of the satellite scenes.</p>
<div class="section level3">
<h3 id="normalized-difference-vegetation-index-ndvi">Normalized Difference Vegetation Index (NDVI)<a class="anchor" aria-label="anchor" href="#normalized-difference-vegetation-index-ndvi"></a></h3>
<p>Suppose we are interested in monitoring vegetation fluctuations using
satellite remote sensors. Scientists have defined a vegetation index to
quantify the amount of green leaf vegetation using the light reflected
in different wavelengths. This index, named Normalized Difference
Vegetation Index (NDVI), exploits the fact that healthy green leaves
strongly absorb red visible light while they mostly reflect light in the
near infrared (NIR). The NDVI is computed as:</p>
<p><span class="math display">\[ NDVI = \frac{NIR - red}{NIR + red}
\]</span></p>
<p>where <span class="math inline">\(NIR\)</span> and <span class="math inline">\(red\)</span> label the reflectance values of the
corresponding wavelengths. NDVI values range from -1 to +1. Values close
to one indicate high density of green leaves. Poorly vegetated areas
typically have NDVI values close to zero. Negative NDVI values often
indicate cloud and water bodies.</p>
<figure><img src="fig/E09/PONE-NDVI.jpg" alt="PONE-NDVI image" class="figure mx-auto d-block"><div class="figcaption">Source: Wu C-D, McNeely E, Cedeño-Laurent JG,
Pan W-C, Adamkiewicz G, Dominici F, et al. (2014) Linking Student
Performance in Massachusetts Elementary Schools with the “Greenness” of
School Surroundings Using Remote Sensing. PLoS ONE 9(10): e108548. <a href="https://doi.org/10.1371/journal.pone.0108548" class="external-link uri">https://doi.org/10.1371/journal.pone.0108548</a>
</div>
</figure><div id="more-resources" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-resources" class="callout-inner">
<h3 class="callout-title">More Resources<a class="anchor" aria-label="anchor" href="#more-resources"></a>
</h3>
<div class="callout-content">
<p>Check out more on NDVI in the NASA Earth Observatory portal: <a href="https://earthobservatory.nasa.gov/features/MeasuringVegetation/measuring_vegetation_2.php" class="external-link">Measuring
Vegetation</a>.</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="load-and-crop-the-data">Load and crop the Data<a class="anchor" aria-label="anchor" href="#load-and-crop-the-data"></a></h3>
<p>For this episode, we will use one of the Sentinel-2 scenes that we
have already employed in the previous episodes.</p>
<div id="introduce-the-data" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="introduce-the-data" class="callout-inner">
<h3 class="callout-title">Introduce the Data<a class="anchor" aria-label="anchor" href="#introduce-the-data"></a>
</h3>
<div class="callout-content">
<p>We’ll continue from the results of the satellite image search that we
have carried out in an exercise from <a href="05-access-data.html">a
previous episode</a>. We will load data starting from the
<code>search.json</code> file.</p>
<p>If you would like to work with the data for this lesson without
downloading data on-the-fly, you can download the raster data using this
<a href="https://figshare.com/ndownloader/files/36028100" class="external-link">link</a>. Save
the <code>geospatial-python-raster-dataset.tar.gz</code> file in your
current working directory, and extract the archive file by
double-clicking on it or by running the following command in your
terminal <code>tar -zxvf geospatial-python-raster-dataset.tar.gz</code>.
Use the file <code>geospatial-python-raster-dataset/search.json</code>
(instead of <code>search.json</code>) to get started with this
lesson.</p>
</div>
</div>
</div>
<p>Let’s load the results of our initial imagery search using
<code>pystac</code>:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> pystac</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>items <span class="op">=</span> pystac.ItemCollection.from_file(<span class="st">"search.json"</span>)</span></code></pre>
</div>
<p>We then select the second item, and extract the URIs of the red and
NIR bands (“red” and “nir08”, respectively):</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>red_uri <span class="op">=</span> items[<span class="dv">1</span>].assets[<span class="st">"red"</span>].href</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>nir_uri <span class="op">=</span> items[<span class="dv">1</span>].assets[<span class="st">"nir08"</span>].href</span></code></pre>
</div>
<p>Let’s load the rasters with <code>open_rasterio</code> using the
argument <code>masked=True</code>.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>red <span class="op">=</span> rioxarray.open_rasterio(red_uri, masked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>nir <span class="op">=</span> rioxarray.open_rasterio(nir_uri, masked<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
<p>Let’s also restrict our analysis to the same crop field area defined
in the previous episode by clipping the rasters using a bounding
box:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>bbox <span class="op">=</span> (<span class="dv">629_000</span>, <span class="dv">5_804_000</span>, <span class="dv">639_000</span>, <span class="dv">5_814_000</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>red_clip <span class="op">=</span> red.rio.clip_box(<span class="op">*</span>bbox)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>nir_clip <span class="op">=</span> nir.rio.clip_box(<span class="op">*</span>bbox)</span></code></pre>
</div>
<p>We can now plot the two rasters. Using <code>robust=True</code> color
values are stretched between the 2nd and 98th percentiles of the data,
which results in clearer distinctions between high and low
reflectances:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>red_clip.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
<figure><img src="fig/E09/red-band.png" alt="red band image" class="figure mx-auto d-block"></figure><div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>nir_clip.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
<figure><img src="fig/E09/NIR-band.png" alt="near infra-red band image" class="figure mx-auto d-block"></figure><p>It is immediately evident how crop fields (rectangular shapes in the
central part of the two figures) appear as dark and bright spots in the
red-visible and NIR wavelengths, respectively, suggesting the presence
of leafy crop at the time of observation (end of March). The same fields
would instead appear as dark spots in the off season.</p>
</div>
</section><section><h2 class="section-heading" id="raster-math">Raster Math<a class="anchor" aria-label="anchor" href="#raster-math"></a>
<a class="anchor" aria-label="anchor" href="#raster-math"></a></h2>
<hr class="half-width"><p>We can perform raster calculations by subtracting (or adding,
multiplying, etc.) two rasters. In the geospatial world, we call this
“raster math”, and typically it refers to operations on rasters that
have the same width and height (including <code>nodata</code> pixels).
We can check the shapes of the two rasters in the following way:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="bu">print</span>(red_clip.shape, nir_clip.shape)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(1, 1000, 1000) (1, 500, 500)</code></pre>
</div>
<p>Both rasters include a single band, but their width and height do not
match. We can now use the <code>reproject_match</code> function, which
both reprojects and clips a raster to the CRS and extent of another
raster.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>red_clip_matched <span class="op">=</span> red_clip.rio.reproject_match(nir_clip)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="bu">print</span>(red_clip_matched.shape)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(1, 500, 500)</code></pre>
</div>
<p>Let’s now compute the NDVI as a new raster using the formula
presented above. We’ll use <code>rioxarray</code> objects so that we can
easily plot our result and keep track of the metadata.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>ndvi <span class="op">=</span> (nir_clip <span class="op">-</span> red_clip_matched)<span class="op">/</span> (nir_clip <span class="op">+</span> red_clip_matched)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="bu">print</span>(ndvi)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray (band: 1, y: 500, x: 500)&gt;
array([[[ 0.7379576 ,  0.77153456,  0.54531944, ...,  0.39254385,
          0.49227372,  0.4465174 ],
        [ 0.7024894 ,  0.7074668 ,  0.3903298 , ...,  0.423283  ,
          0.4706971 ,  0.45964912],
        [ 0.6557818 ,  0.5610572 ,  0.46742022, ...,  0.4510345 ,
          0.43815723,  0.6005133 ],
        ...,
        [ 0.02391171,  0.21843003,  0.02479339, ..., -0.50923485,
         -0.53367877, -0.4955414 ],
        [ 0.11376493,  0.17681159, -0.1673566 , ..., -0.5221932 ,
         -0.5271318 , -0.4852753 ],
        [ 0.45398772, -0.00518135,  0.03346133, ..., -0.5019455 ,
         -0.4987013 , -0.49081364]]], dtype=float32)
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6.29e+05 6.29e+05 6.29e+05 ... 6.39e+05 6.39e+05
  * y            (y) float64 5.814e+06 5.814e+06 ... 5.804e+06 5.804e+06
    spatial_ref  int64 0</code></pre>
</div>
<p>We can now plot the output NDVI:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>ndvi.plot()</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-map.png" alt="NDVI map" class="figure mx-auto d-block"></figure><p>Notice that the range of values for the output NDVI is between -1 and
1. Does this make sense for the selected region?</p>
<p>Maps are great, but it can also be informative to plot histograms of
values to better understand the distribution. We can accomplish this
using a built-in xarray method we have already been using:
<code>plot</code></p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>ndvi.plot.hist()</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-hist.png" alt="NDVI histogram" class="figure mx-auto d-block"></figure><div id="exercise-explore-ndvi-raster-values" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-explore-ndvi-raster-values" class="callout-inner">
<h3 class="callout-title">Exercise: Explore NDVI Raster Values<a class="anchor" aria-label="anchor" href="#exercise-explore-ndvi-raster-values"></a>
</h3>
<div class="callout-content">
<p>It’s often a good idea to explore the range of values in a raster
dataset just like we might explore a dataset that we collected in the
field. The histogram we just made is a good start but there’s more we
can do to improve our understanding of the data.</p>
<ol style="list-style-type: decimal"><li>What is the min and maximum value for the NDVI raster
(<code>ndvi</code>) that we just created? Are there missing values?</li>
<li>Plot a histogram with 50 bins instead of 8. What do you notice that
wasn’t clear before?</li>
<li>Plot the <code>ndvi</code> raster using breaks that make sense for
the data.</li>
</ol></div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<ol style="list-style-type: decimal"><li>Recall, if there were nodata values in our raster, we would need to
filter them out with <code>.where()</code>. Since we have loaded the
rasters with <code>masked=True</code>, missing values are already
encoded as <code>np.nan</code>’s. The <code>ndvi</code> array actually
includes a single missing value.</li>
</ol><div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="bu">print</span>(ndvi.<span class="bu">min</span>().values)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="bu">print</span>(ndvi.<span class="bu">max</span>().values)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="bu">print</span>(ndvi.isnull().<span class="bu">sum</span>().values)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="op">-</span><span class="fl">0.99864775</span></span>
<span><span class="fl">0.9995788</span></span>
<span><span class="fl">1</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal"><li>Increasing the number of bins gives us a much clearer view of the
distribution. Also, there seem to be very few NDVI values larger than
~0.9.</li>
</ol><div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>ndvi.plot.hist(bins<span class="op">=</span><span class="dv">50</span>)</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-hist-bins.png" alt="NDVI histogram with 50 bins" class="figure mx-auto d-block"></figure><ol start="3" style="list-style-type: decimal"><li>We can discretize the color bar by specifying the intervals via the
<code>levels</code> argument to <code>plot()</code>. Suppose we want to
bin our data in the following intervals:</li>
</ol><ul><li>
<span class="math inline">\(-1 \le NDVI \lt 0\)</span> for
water;</li>
<li>
<span class="math inline">\(0 \le NDVI \lt 0.2\)</span> for no
vegetation;</li>
<li>
<span class="math inline">\(0.2 \le NDVI \lt 0.7\)</span> for sparse
vegetation;</li>
<li>
<span class="math inline">\(0.7 \le NDVI \lt 1\)</span> for dense
vegetation.</li>
</ul><div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>class_bins <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>, <span class="fl">0.</span>, <span class="fl">0.2</span>, <span class="fl">0.7</span>, <span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>ndvi.plot(levels<span class="op">=</span>class_bins)</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-map-binned.png" alt="binned NDVI map" class="figure mx-auto d-block"></figure></div>
</div>
</div>
</div>
<p>Missing values can be interpolated from the values of neighbouring
grid cells using the <code>.interpolate_na</code> method. We then save
<code>ndvi</code> as a GeoTiff file:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>ndvi_nonan <span class="op">=</span> ndvi.interpolate_na(dim<span class="op">=</span><span class="st">"x"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>ndvi_nonan.rio.to_raster(<span class="st">"NDVI.tif"</span>)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="classifying-continuous-rasters-in-python">Classifying Continuous Rasters in Python<a class="anchor" aria-label="anchor" href="#classifying-continuous-rasters-in-python"></a>
<a class="anchor" aria-label="anchor" href="#classifying-continuous-rasters-in-python"></a></h2>
<hr class="half-width"><p>Now that we have a sense of the distribution of our NDVI raster, we
can reduce the complexity of our map by classifying it. Classification
involves assigning each pixel in the raster to a class based on its
value. In Python, we can accomplish this using the
<code>numpy.digitize</code> function.</p>
<p>First, we define NDVI classes based on a list of values, as defined
in the last exercise: <code>[-1, 0., 0.2, 0.7, 1]</code>. When bins are
ordered from low to high, as here, <code>numpy.digitize</code> assigns
classes like so:</p>
<figure><img src="fig/E09/NDVI-classes.jpg" alt="NDVI classes" class="figure mx-auto d-block"><div class="figcaption">Source: Image created for this lesson (<a href="LICENSE.html">license</a>)</div>
</figure><p>Note that, by default, each class includes the left but not the right
bound. This is not an issue here, since the computed range of NDVI
values is fully contained in the open interval (-1; 1) (see exercise
above).</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="im">import</span> xarray</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co"># Defines the bins for pixel values</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>class_bins <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>, <span class="fl">0.</span>, <span class="fl">0.2</span>, <span class="fl">0.7</span>, <span class="dv">1</span>)</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co"># The numpy.digitize function returns an unlabeled array, in this case, a</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co"># classified array without any metadata. That doesn't work--we need the</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co"># coordinates and other spatial metadata. We can get around this using</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co"># xarray.apply_ufunc, which can run the function across the data array while</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="co"># preserving metadata.</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>ndvi_classified <span class="op">=</span> xarray.apply_ufunc(</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    np.digitize,</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>    ndvi_nonan,</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>    class_bins</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>)</span></code></pre>
</div>
<p>Let’s now visualize the classified NDVI, customizing the plot with
proper title and legend. We then export the figure in PNG format:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="im">import</span> earthpy.plot <span class="im">as</span> ep</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co"># Define color map of the map legend</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>ndvi_colors <span class="op">=</span> [<span class="st">"blue"</span>, <span class="st">"gray"</span>, <span class="st">"green"</span>, <span class="st">"darkgreen"</span>]</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>ndvi_cmap <span class="op">=</span> ListedColormap(ndvi_colors)</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co"># Define class names for the legend</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>category_names <span class="op">=</span> [</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>    <span class="st">"Water"</span>,</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>    <span class="st">"No Vegetation"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>    <span class="st">"Sparse Vegetation"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>    <span class="st">"Dense Vegetation"</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>]</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co"># We need to know in what order the legend items should be arranged</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a>category_indices <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(category_names)))</span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co"># Make the plot</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a>im <span class="op">=</span> ndvi_classified.plot(cmap<span class="op">=</span>ndvi_cmap, add_colorbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a>plt.title(<span class="st">"Classified NDVI"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co"># earthpy helps us by drawing a legend given an existing image plot and legend items, plus indices</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a>ep.draw_legend(im_ax<span class="op">=</span>im, classes<span class="op">=</span>category_indices, titles<span class="op">=</span>category_names)</span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a><span class="co"># Save the figure</span></span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a>plt.savefig(<span class="st">"NDVI_classified.png"</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-classified.png" alt="classified NDVI map" class="figure mx-auto d-block"></figure><p>We can finally export the classified NDVI raster object to a GeoTiff
file. The <code>to_raster()</code> function by default writes the output
file to your working directory unless you specify a full file path.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>ndvi_classified.rio.to_raster(<span class="st">"NDVI_classified.tif"</span>, dtype<span class="op">=</span><span class="st">"int32"</span>)</span></code></pre>
</div>
<div id="exercise-compute-the-ndvi-for-the-texel-island" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-compute-the-ndvi-for-the-texel-island" class="callout-inner">
<h3 class="callout-title">Exercise: Compute the NDVI for the Texel island<a class="anchor" aria-label="anchor" href="#exercise-compute-the-ndvi-for-the-texel-island"></a>
</h3>
<div class="callout-content">
<p>Data are often more interesting and powerful when we compare them
across various locations. Let’s compare the computed NDVI map with the
one of another region in the same Sentinel-2 scene: the <a href="https://en.wikipedia.org/wiki/Texel" class="external-link">Texel island</a>, located in
the North Sea.</p>
<ol start="0" style="list-style-type: decimal"><li>You should have the red- and the NIR-band rasters already loaded
(<code>red</code> and <code>nir</code> variables, respectively).</li>
<li>Crop the two rasters using the following bounding box:
<code>(610000, 5870000, 630000, 5900000)</code>. Don’t forget to check
the shape of the data, and make sure the cropped areas have the same
CRSs, heights and widths.</li>
<li>Compute the NDVI from the two raster layers and check the max/min
values to make sure the data is what you expect.</li>
<li>Plot the NDVI map and export the NDVI as a GeoTiff.</li>
<li>Compare the distributions of NDVI values for the two regions
investigated.</li>
</ol></div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<ol style="list-style-type: decimal"><li>We crop the area of interest using <code>clip_box</code>:</li>
</ol><div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>bbox_texel <span class="op">=</span> (<span class="dv">610000</span>, <span class="dv">5870000</span>, <span class="dv">630000</span>, <span class="dv">5900000</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>nir_texel <span class="op">=</span> nir.rio.clip_box(<span class="op">*</span>bbox_texel)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>red_texel <span class="op">=</span> red.rio.clip_box(<span class="op">*</span>bbox_texel)</span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal"><li>Reproject and clip one raster to the extent of the smaller raster
using <code>reproject_match</code>. The lines of code below assign a
variable to the reprojected raster and calculate the NDVI.</li>
</ol><div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>red_texel_matched <span class="op">=</span> red_texel.rio.reproject_match(nir_texel)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>ndvi_texel <span class="op">=</span> (nir_texel <span class="op">-</span> red_texel_matched)<span class="op">/</span> (nir_texel <span class="op">+</span> red_texel_matched)</span></code></pre>
</div>
<ol start="3" style="list-style-type: decimal"><li>Plot the NDVI and save the raster data as a GeoTIFF file.</li>
</ol><div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>ndvi_texel.plot()</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>ndvi_texel.rio.to_raster(<span class="st">"NDVI_Texel.tif"</span>)</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-map-Texel.png" alt="NDVI map Texel" class="figure mx-auto d-block"></figure><ol start="4" style="list-style-type: decimal"><li>Compute the NDVI histogram and compare it with the region that we
have previously investigated. Many more grid cells have negative NDVI
values, since the area of interest includes much more water. Also, NDVI
values close to zero are more abundant, indicating the presence of bare
ground (sand) regions.</li>
</ol><div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>ndvi_texel.plot.hist(bins<span class="op">=</span><span class="dv">50</span>)</span></code></pre>
</div>
<figure><img src="fig/E09/NDVI-hist-Texel.png" alt="NDVI histogram Texel" class="figure mx-auto d-block"></figure></div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>Python’s built-in math operators are fast and simple options for
raster math.</li>
<li>numpy.digitize can be used to classify raster values in order to
generate a less complicated map.</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="08-crop-raster-data.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="10-zonal-statistics.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="08-crop-raster-data.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Crop raster data
        </a>
        <a class="chapter-link float-end" href="10-zonal-statistics.html" rel="next">
          Next: Calculating Zonal...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/geospatial-python/edit/main/episodes/09-raster-calculations.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/geospatial-python/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/geospatial-python/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/geospatial-python/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.5" class="external-link">sandpaper (0.16.5)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.6" class="external-link">pegboard (0.7.6)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.3" class="external-link">varnish (1.0.3)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/geospatial-python/09-raster-calculations.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Raster Calculations in Python",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/geospatial-python/09-raster-calculations.html",
  "identifier": "https://carpentries-incubator.github.io/geospatial-python/09-raster-calculations.html",
  "dateCreated": "2024-03-05",
  "dateModified": "2023-08-14",
  "datePublished": "2024-08-20"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

